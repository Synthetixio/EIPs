---
sip: 252
title: Liquidation of SNX Escrow
network: Ethereum & Optimism
status: Draft
type: Governance
author: Kaleb
created: 2022-06-17
---

## Simple Summary

<!--"If you can't explain it simply, you don't understand it well enough." Simply describe the outcome the proposed changes intends to achieve. This should be non-technical and accessible to a casual community member.-->

Update the snx liquidation functionality, laid out in [SIP-148](https://sips.synthetix.io/sips/sip-148/), to allow for the following:
- SNX escrow entries can be liquidated to restore an account back to target staking ratio
- Update the flag and liquidation reward mechanism as to vest snx, in order to pay for flagging/liquidation when a user does not hold enough snx in his account

## Abstract

<!--A short (~200 word) description of the proposed change, the abstract should clearly describe the proposed change. This is what *will* be done if the SIP is implemented, not *why* it should be done or *how* it will be done. If the SIP proposes deploying a new contract, write, "We propose to deploy a new contract that will do x".-->

The new `Liquidator` contract should allow both SNX tokens held in an account as well as escrow entries to be liquidated until the target issuance ratio of a snx staker is restored. In case an account does not hold enough snx to restore back to the target issuance ratio, then their stakers account is closed with debt is cleared and all snx in the account is sent to other stakers as part of the liquidation. If the self-liquidate method is called, a user's account is liquidated with **only** the snx available in his account (escrow is not utilized to repay debt with self-liquidation).

## Motivation

<!--This is where you explain the reasoning behind how you propose to solve the problem. Why did you propose to implement the change in this way, what were the considerations and trade-offs? The rationale fleshes out what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->

The reasoning behind this SIP, is that accounts can circumvent the intention of [SIP-148](https://sips.synthetix.io/sips/sip-148/) by not vesting their escrow entries, and therefore obtain a free put option on their debt without expiry. Allowing for escrow entries to be liquidated helps restore network collateralization ratio, as the debt would shift to other stakers, who acquire escrowed snx by taking on delinquent debt.
There are currently around 2.8m$ worth of debt between optimism and ethereum, backed by 1.4m worth of escrowed SNX, which can't be liquidated because of restriction liquidations. With the changes proposed in this sip, that debt would be wiped clean allowing the protocol to be more resilient and better capitalized in the long run.

## Specification
<!--The specification should describe the syntax and semantics of any new feature, there are five sections
1. Overview
2. Rationale
3. Technical Specification
4. Test Cases
5. Configurable Values
-->

### Overview

<!--This is a high level overview of *how* the SIP will solve the problem. The overview should clearly describe how the new feature will be implemented.-->
The main workflow of the liquidation contract is as follows:
1) Flag and Liquidation Mechanism, describing the incentives that result in accounts being flagged and liquidated.
2) Liquidation Workflow, describing the liquidation mechanism with all the scenarios that could result from stakers having different collateralization ratios.

#### Flag and Liquidation Mechanism

The flag/liquidation incentive scheme is mostly identical to the one specified in [SIP-148](https://sips.synthetix.io/sips/sip-148/), with the followings additions:
- A flagged account immediately gives up snx to the flagger. Whereas in the SIP-148 implementation, flagger receives a reward only upon liquidation.
- The delinquent account holds more snx than the flag/liquidation reward. Therefore, the flagger/liquidator receives the reward into his account from the delinquent account, directly upon calling flag/liquidation.
- The flagged/liquidated account does not hold enough snx, but holds enough escrowed snx. Therefore, the flagger/liquidator receives rewards directly from the delinquent account, and the remaining amount to cover the reward is covered by vesting the most recent entries of the flagged/liquidated account to pay the flagging/liquidation. Any excess snx that are vested are restored to the staker with new entries having the same expiry as those that were previously vested to pay the flagger/liquidator.
- The flagged account does not hold enough snx to be flagged/liquidated. The account is closed(i.e. all debt is cleared) and all the snx available (if any) is vested or sent directly to the account calling flag/liquidate.
- Only in the event of a staker is above the target issuance ratio, is the liquidation flag removed.  In other words, calling self-liquidate when an account is flagged does remove the flag if the staker is not back to the target issuance ratio.

The above workflow precedes the computation related to the liquidation event, meaning a staker could lose more snx than the amount necessary to cover debt, since flagger/liquidator receives the reward first. 

##### Liquidation Workflow

###### Self-Liquidation
A user can call the self-liquidation functionality at any time his account drops below the collateralization ratio. The following situation can arise upon self-liquidation call:
1) The user holds enough snx (not escrowed snx) to restore the target issuance ratio. The user self-liquidates, with the snx available in his account and a self-liquidation penalty being imposed (equation 1 in calculation methodology section).
2) The user does not hold enough snx in his account to restore the target issuance ratio, but holds some snx. Upon calling self-liquidate, all the snx available in his account is used to repay as much debt as possible, taking into account the self-liquidation penalty (equation 2).
3) The user does not hold any snx in his account (but has escrow entries) and calls the self-liquidate functionality. The transaction reverts.
4) The user is above the target issuance ratio and calls the self-liquidate. The transaction reverts.

###### Liquidation
As mentioned in SIP-148, a liquidation method can be called after the `minLiquidationDelay` runs out, the below scenarios can arise:
1) The user holds enough snx to restore the target issuance ratio. The user is liquidated, with the snx available in his account and a liquidation penalty is imposed (equation 1).
2) The user does not hold enough snx to restore the target issuance ratio, but holds enough snx + escrowed entries to restore to the target issuance ratio. The user is liquidated, with the snx available in his account utilized to repay debt, the remainder is obtained by immediately vesting the most recent entries available in order to restore the collateralization ratio to the target issuance ratio. If an entry holds more snx than required to repay debt, then a new entry with the excess snx is added to the account with the same vesting period as the one used for liquidation.
3) The user does not hold enough snx in his account or in escrow to restore his collateralization ratio to the target issuance ratio. Upon liquidation call, the debt is cleared and all the snx in the account are immediately vested and paid to stakers.
4) The user is above the target issuance ratio and liquidate is called. The transaction reverts.
5) The `liquidationDelay` has not run out and liquidation method is called. The transaction reverts.

###### Calculation Methodology

The below variables are used to describe the components of the liquidation computations:
- V = Value of SNX and Escrow Entries in USD terms
- D = Debt Balance
- t = Target Collateral Ratio
- S = Amount of debt to settle
- P = Liquidation Penalty %
- L = Value of SNX liquidated in USD terms

1) Account holds enough SNX to restore to the target staking ratio, the following is used to compute the debt to be settled, specified in [SIP-15](https://sips.synthetix.io/sips/sip-15/):

\\[
S = \frac{t * D - V}{t - (1 + P)}
\\]

\\[
L = S * (1+P)
\\]

2) Account does not hold enough SNX to restore to the target staking ratio, the following is used upon self-liquidation call, specified in [SIP-240](https://sips.synthetix.io/sips/sip-240/):

\\[
S = V*(1 + P)
\\]

### Rationale

<!--This is where you explain the reasoning behind how you propose to solve the problem. Why did you propose to implement the change in this way, what were the considerations and trade-offs. The rationale fleshes out what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->

The following points are points are worth mentioning pertaining to the implementation:
- The fundamental reason behind not allowing for self-liquidation with escrow funds, is that it provides a way to sell escrowed snx immediately for debt relief, while the penalty might not compensate stakers  for the uncertainty around SNX price and the time it takes for liquidation rewards to vest.
- Upon liquidation / self-liquidation, the SNX relinquished by the delinquent account can be claimable by snx stakers with a `liquidationEscrowDuration` before the snx is vested. SNX Escrow entries that are used for liquidation are deleted. 
- Similar to the implementation in SIP-148, SNX is claimable by the stakers on the same chain where the liquidation event took place. Stakers on the other chain are compensated for the liquidation with pDAO receiving the snx needed to compensate the other chain from the weekly inflation print and adding escrow entries to stakers that were staking at the time of the liquidation event.
- The account merge methodology is deprecated due to the changes required on `RewardEscrowV2` and in order to simplify the implementation.

### Technical Specification
<!--The technical specification should outline the public API of the changes proposed. That is, changes to any of the interfaces Synthetix currently exposes or the creations of new ones.-->

Pending

### Test Cases

<!--Test cases for an implementation are mandatory for SIPs but can be included with the implementation..-->

#### Test Cases on Flagging
- Given that a staker's collateralization is below the `liquidationRatio`, is not flagged and a flag reward of 4 snx
    - When an account attempts to flag the staker
      - Given the staker has 5 snx in his account and 2 escrow entries of 1 snx and 3 snx with expiries of 5 days and 10 days respectively
        - ✅ Then it succeeds and the following take place:
        - 4 snx is sent from the staker to the flagger
    - Given the staker has 1 snx in his account and 2 escrow entries of 1 snx and 3 snx with expiries of 5 days and 10 days respectively
        - ✅ Then it succeeds and the following take place:
        - 1 snx is sent from the staker
        - The snx entry expiring in 5 days is vested immediately and sent to the flagger (i.e. 1 snx)
        - The snx entry expiring in 10 days is vested immediately:
            a) 2 snx is sent to the staker
            b) 1 snx is added as a new escrow entry with vesting in 10 days
  - Given the staker has no snx in his account and 2 escrow entries of 1 snx and 2 snx with expiries of 5 days and 10 days respectively
        - ✅ Then it succeeds and the following take place:
        - The snx entry expiring in 5 days is vested immediately and sent to the flagger (i.e. 1 snx)
        - The 2 snx entry expiring in 5 days is vested immediately and sent to the flagger (i.e. 1 snx)
        - The stakers' debt is cleared as it holds no more snx
- Given that a staker's collateralization is above the `liquidationRatio` and is not flagged 
    - When an account attempts to flag the staker
        - ❌ Then it reverts, due to the address not being below the liquidationRatio
- Given that a staker's collateralization is below the `liquidationRatio` and is flagged 
    - When an account attempts to flag the staker
        - ❌ Then it reverts, due to the address being already flagged

#### Test Cases on self-liquidation
- Given that a staker's debt is 10$, snx balance is 20 snx, snx price at 1$, a target staking ratio of 300% and a self liquidation of 30%
    - When the stakers attempts to self-liquidate
    - ✅ Then transactions succeeds and the following take place:
        - 
    - Given the staker has 1 snx in his account and 2 escrow entries of 1 snx and 3 snx with expiries of 5 days and 10 days respectively
        - ✅ Then it succeeds and the following take place:
        - 1 snx is sent from the staker
        - The snx entry expiring in 5 days is vested immediately and sent to the flagger (i.e. 1 snx)
        - The snx entry expiring in 10 days is vested immediately:
            a) 2 snx is sent to the staker
            b) 1 snx is added as a new escrow entry with vesting in 10 days
  - Given the staker has no snx in his account and 2 escrow entries of 1 snx and 2 snx with expiries of 5 days and 10 days respectively
        - ✅ Then it succeeds and the following take place:
        - The snx entry expiring in 5 days is vested immediately and sent to the flagger (i.e. 1 snx)
        - The 2 snx entry expiring in 5 days is vested immediately and sent to the flagger (i.e. 1 snx)
        - The stakers' debt is cleared as it holds no more snx
- Given that a staker's collateralization is above the `liquidationRatio` and is not flagged 
    - When an account attempts to flag the staker
        - ❌ Then it reverts, due to the address not being below the liquidationRatio
- Given that a staker's collateralization is below the `liquidationRatio` and is flagged 
    - When an account attempts to flag the staker
        - ❌ Then it reverts, due to the address being already flagged


### Configurable Values (Via SCCP)

The same configurable values laid out in `SIP-148` and `SIP-251` are configurable via SCCP.

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).